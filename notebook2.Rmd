---
title: "Ratio to MA filter"
output: html_notebook
---

```{r}
tourism.data=readxl::read_xlsx("Tourism_new.xlsx")
head(tourism.data)
```

```{r}
dim(tourism.data)
```


```{r}
tail(tourism.data)
```


```{r}
# Monthly Seasonality (frequency set to 12 for monthly data)
tourism <- ts(tourism.data[,2],start= c(1998),end = c(2019,12),frequency=12)
tourism
```


```{r}
plot(tourism)
```
The graph clearly shows a seasonality and an increasing trend i.e. a multiplicative variance. So to remove the variance, to convert it into a additive series, we need to find the log returns of the series. Let us first plot the log returns of the series and see how it looks. 

```{r}
log_tourism <- log(tourism)
plot(log_tourism)
```

Checking the existence of seasonality using dummy indices. 

```{r}
tourism
```

```{r}
log_tourism
```


```{r results="hide" , message=FALSE, warningFALSE}
library(zoo)
as.yearmon(time(log_tourism))
```


```{r results="hide" , message=FALSE, warningFALSE}
log_tourism[cycle(log_tourism)==c(1)]
```

```{r}
FTA_mat <- as.data.frame(matrix(log_tourism, nrow = 22, ncol= 12, byrow = T))
colnames(FTA_mat) <- month.name
rownames(FTA_mat) <- 1998:2019
View(FTA_mat)
```

```{r}
p <- month.abb[cycle(log_tourism)]
p
```

```{r results = "hide" , message = FALSE, warning= FALSE}
library(caret)
library(lattice)
library(ggplot2)
library(mltools)
library(data.table)
p <- as.factor(p)
dmy <- one_hot(as.data.table(p))
head(dmy, n = 10)
```


```{r results = "hide" , message = FALSE, warning= FALSE}
dim(dmy)
typeof(dmy)
```




```{r}
m <- as.matrix(log_tourism)
X <- cbind(as.data.frame(m), as.data.frame(dmy))
names(X)[1] <- "Y"
head(X, n= 10)
```


```{r}
summary(lm(Y~.,data = X))
```

The lm summary shows that many of the seasonal coefficients are significant showing that it has got a seasonality.
Next we apply *Ratio to MA filter*

```{r, message= FALSE , warning = FALSE}
library(astsa)
library(forecast)
MA <- ma(log_tourism, 12)
id <- seq(1,length(log_tourism),1)
detrended <- log_tourism-MA
head(detrended, n = 10)
tail(detrended, n= 10)
```

```{r}
FTA_mat <- as.data.frame(matrix(detrended, nrow = 22, ncol= 12, byrow = T))
colnames(FTA_mat) <- month.name
rownames(FTA_mat) <- 1998:2019
View(FTA_mat)
S <- colMeans(FTA_mat, na.rm = T)
S_mean <- mean(S)
S_index <- S - S_mean
S_index
Deseasonalised_log_tourism <- log_tourism-S_index
Deseasonalised_log_tourism

```


```{r}
plot(log_tourism, main = "FTA from 1998 - 2019(log transformed)", ylab = "Number of tourists")
```

```{r}
plot(Deseasonalised_log_tourism, main = "Deseasonalised FTA 1998-2019 ", ylab = "Number FT")
```

```{r}
plot(log_tourism, main = "FTA from 1998 - 2019(original = black, Deseasoned = Red)", ylab = "Number of tourists")
lines(Deseasonalised_log_tourism, col = "red")
```


```{r}
class(Deseasonalised_log_tourism)
```

```{r}
plot(diff(Deseasonalised_log_tourism))
```


```{r}
library(urca)
summary(ur.df(Deseasonalised_log_tourism, type = c("trend")))
```

```{r}
summary(ur.df(Deseasonalised_log_tourism, type = "trend"))
```

```{r}
summary(ur.df(diff(Deseasonalised_log_tourism), type = "trend"))
```


```{r}
acf2(diff(Deseasonalised_log_tourism), lags = 120)
```

```{r}
arima(Deseasonalised_log_tourism, order=c(2,1,2))
```

```{r}
arima(Deseasonalised_log_tourism, order=c(2,1,0))
```

```{r}
Dlt_train <-  window(Deseasonalised_log_tourism, end = c(2017,12))
Dlt_test <- window(Deseasonalised_log_tourism, start= c(2018))
```

```{r}
summary(arima(Dlt_train, order=c(2,1,2)))
```


```{r}
s.for <- sarima.for(Dlt_train, p = 2, d = 1,q = 2, n.ahead = 24)
s.act <- s.for$pred+S_index
plot(s.act)
lines(log_tourism, col = "red")
```

```{r}
Dlt_test.act <- Dlt_test+S_index
mape <- mean(abs((s.act-Dlt_test.act)/Dlt_test.act))*100
mape
```



